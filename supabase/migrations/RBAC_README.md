# RBAC (Role-Based Access Control) System

This document describes the RBAC system implemented in the booking system to replace hardcoded admin permissions.

## Overview

The RBAC system provides a flexible and secure way to manage user permissions through roles and permissions rather than hardcoded checks.

## Database Schema

### Tables

#### `user_roles`
Stores the roles assigned to each user.

```sql
CREATE TABLE public.user_roles (
    id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    user_id UUID REFERENCES auth.users ON DELETE CASCADE NOT NULL,
    role app_role NOT NULL,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT timezone('utc'::text, now()) NOT NULL,
    created_by UUID REFERENCES auth.users ON DELETE SET NULL,
    UNIQUE (user_id, role)
);
```

#### `role_permissions`
Stores the permissions assigned to each role.

```sql
CREATE TABLE public.role_permissions (
    id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    role app_role NOT NULL,
    permission app_permission NOT NULL,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT timezone('utc'::text, now()) NOT NULL,
    UNIQUE (role, permission)
);
```

### Types

#### `app_role`
Available roles in the system:
- `admin` - Full system access
- `moderator` - Can view and moderate content
- `support` - Can view and update requests
- `user` - Basic user access

#### `app_permission`
Available permissions in the system:
- `requests.view_all` - Can view all requests
- `requests.update_all` - Can update all requests
- `requests.delete_all` - Can delete all requests
- `requests.complete_all` - Can complete all requests
- `requests.cancel_all` - Can cancel all requests
- `comments.view_all` - Can view all comments
- `comments.update_all` - Can update all comments
- `comments.delete_all` - Can delete all comments
- `comments.moderate_all` - Can moderate all comments

## Helper Functions

### `has_permission(required_permission)`
Checks if the current user has a specific permission.

```sql
SELECT public.has_permission('requests.view_all');
```

### `has_role(required_role)`
Checks if the current user has a specific role.

```sql
SELECT public.has_role('admin');
```

## Default Role Permissions

### Admin Role
- All permissions

### Moderator Role
- `requests.view_all`
- `requests.update_all`
- `comments.view_all`
- `comments.moderate_all`

### Support Role
- `requests.view_all`
- `requests.update_all`
- `comments.view_all`
- `comments.update_all`

### User Role
- `requests.view_all` (basic access)

## Usage Examples

### Assigning a role to a user
```sql
INSERT INTO public.user_roles (user_id, role) 
VALUES ('user-uuid', 'admin');
```

### Checking permissions in policies
```sql
-- In RLS policies
public.has_permission('requests.view_all')
```

### Adding a new permission
```sql
-- Add new permission to enum
ALTER TYPE public.app_permission ADD VALUE 'new_permission';

-- Grant permission to roles
INSERT INTO public.role_permissions (role, permission) 
VALUES ('admin', 'new_permission');
```

## Migration from Hardcoded System

The migration process:

1. **20241201000003_implement_rbac_system.sql** - Creates the RBAC system
2. **20241201000004_migrate_existing_admins.sql** - Migrates existing admin users

Users with 'admin' in their `full_name` are automatically assigned the admin role.

## Security Considerations

- All tables have Row Level Security (RLS) enabled
- Helper functions use `SECURITY DEFINER` to ensure proper execution context
- Role assignments are restricted to admin users only
- Permissions are granular and specific to actions

## Best Practices

1. **Always use helper functions** instead of direct role checks
2. **Grant minimal permissions** - follow the principle of least privilege
3. **Audit role assignments** regularly
4. **Use specific permissions** rather than broad roles when possible
5. **Test policies thoroughly** before deployment

## Troubleshooting

### Common Issues

1. **User can't access expected resources**
   - Check if user has the correct role assigned
   - Verify the role has the required permissions
   - Check RLS policies are correctly configured

2. **Permission denied errors**
   - Ensure helper functions are being used correctly
   - Verify user is authenticated
   - Check if user has any roles assigned

### Debugging Queries

```sql
-- Check user's roles
SELECT role FROM public.user_roles WHERE user_id = auth.uid();

-- Check user's permissions
SELECT rp.permission 
FROM public.user_roles ur
JOIN public.role_permissions rp ON ur.role = rp.role
WHERE ur.user_id = auth.uid();

-- Check all role assignments
SELECT 
    p.email,
    ur.role,
    array_agg(rp.permission) as permissions
FROM public.user_roles ur
JOIN public.profiles p ON ur.user_id = p.id
LEFT JOIN public.role_permissions rp ON ur.role = rp.role
GROUP BY p.email, ur.role;
``` 